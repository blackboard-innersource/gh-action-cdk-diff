name: CDK Diff
description: Diff two cdk.out directories
inputs:
  github-token:
    description: The GitHub token to use for the action. This token is automatically created by GitHub and does not require any configuration.
    required: true
  working-directory:
    description: The working directory to run the action in. This is the directory where the CDK app is located.
    required: false
    default: "${{ github.workspace }}"
  base:
    description: The cdk.out directory of the baseline or current synth
    required: true
    default: base.cdk.out
  head:
    description: The cdk.out directory of the new synth
    required: true
    default: head.cdk.out
  disable-comments:
    description: If true, the action will not create a comments on the PR.
    required: false
    default: "false"
  disable-labels:
    description: If true, the action will not create labels on the PR.
    required: false
    default: "false"
  disable-summary:
    description: If true, the action will not summarize the diff output via a special PR comment.
    required: false
    default: "false"
  ignore-changes:
    description: A list of resources that are ignored in the diff. This is a comma-separated list of resource logical IDs.
    required: false
    default: "false"
  ignore-asset-only-changes:
    description: If true, the action will ignore changes to assets in the diff. This is useful for large diffs.
    required: false
    default: "false"
outputs:
  has-changes:
    description: Has the value of false if no differences found or true if differences found
    value: steps.cdk-diff.outputs.has-changes
  has-destructive-changes:
    description: Has the value of false if no differences found or true if differences found
    value: steps.cdk-diff.outputs.has-destructive-changes
  has-security-group-changes:
    description: Has the value of false if no differences found or true if differences found
    value: steps.cdk-diff.outputs.has-security-group-changes
  has-iam-changes:
    description: Has the value of false if no differences found or true if differences found
    value: steps.cdk-diff.outputs.has-iam-changes
runs:
  using: "composite"
  steps:
    - name: Install dependencies
      working-directory: ${{ github.action_path }}
      shell: bash
      run: |
        npm ci
        npm install @aws-cdk/aws-service-spec

    - name: Run CDK Diff
      id: cdk-diff
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        INPUT_GITHUB-TOKEN: ${{ inputs.github-token }}
#        BASE_PATH: ${{ github.workspace }}/${{ inputs.base }}
#        HEAD_PATH: ${{ github.workspace }}/${{ inputs.head }}
        INPUT_BASE: ${{ inputs.base }}
        INPUT_HEAD: ${{ inputs.head }}
        INPUT_DISABLE-COMMENTS: ${{ inputs.disable-comments }}
        INPUT_DISABLE-LABELS: ${{ inputs.disable-labels }}
        INPUT_DISABLE-SUMMARY: ${{ inputs.disable-summary }}
        INPUT_IGNORE-CHANGES: ${{ inputs.ignore-changes }}
        INPUT_IGNORE-ASSET-CHANGES: ${{ inputs.ignore-asset-only-changes }}
#      run: node ${{ github.action_path }}/dist/index.js
      run: npx ts-node ${{ github.action_path }}/src/index.ts